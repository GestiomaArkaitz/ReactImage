{"version":3,"file":"compass.js","sources":["../../src/plugins/compass/index.js"],"sourcesContent":["import * as THREE from 'three';\nimport { AbstractPlugin, CONSTANTS, SYSTEM, utils } from '../..';\nimport compass from './compass.svg';\nimport './style.scss';\n\n\n/**\n * @typedef {Object} PSV.plugins.CompassPlugin.Options\n * @property {string} [size='120px'] - size of the compass\n * @property {string} [position='top left'] - position of the compass\n * @property {string} [backgroundSvg] - SVG used as background of the compass\n * @property {string} [coneColor='rgba(255, 255, 255, 0.5)'] - color of the cone of the compass\n * @property {boolean} [navigation=true] - allows to click on the compass to rotate the viewer\n * @property {string} [navigationColor='rgba(255, 0, 0, 0.2)'] - color of the navigation cone\n * @property {PSV.plugins.CompassPlugin.Hotspot[]} [hotspots] - small dots visible on the compass (will contain every marker with the \"compass\" data)\n * @property {string} [hotspotColor='rgba(0, 0, 0, 0.5)'] - default color of hotspots\n */\n\n/**\n * @typedef {PSV.ExtendedPosition} PSV.plugins.CompassPlugin.Hotspot\n * @type {string} [color] - override the global \"hotspotColor\"\n */\n\n\nconst HOTSPOT_SIZE_RATIO = 1 / 40;\n\n\n/**\n * @summary Adds a compass on the viewer\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class CompassPlugin extends AbstractPlugin {\n\n  static id = 'compass';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.CompassPlugin.Options} options\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {PSV.plugins.CompassPlugin.Options}\n     * @private\n     */\n    this.config = {\n      size           : '120px',\n      position       : 'top left',\n      backgroundSvg  : compass,\n      coneColor      : 'rgba(255, 255, 255, 0.5)',\n      navigation     : true,\n      navigationColor: 'rgba(255, 0, 0, 0.2)',\n      hotspotColor   : 'rgba(0, 0, 0, 0.5)',\n      ...options,\n    };\n    this.config.position = utils.cleanPosition(this.config.position, 'top left');\n\n    /**\n     * @private\n     */\n    this.prop = {\n      mouse    : null,\n      mouseDown: false,\n      markers  : [],\n    };\n\n    /**\n     * @type {PSV.plugins.MarkersPlugin}\n     * @private\n     */\n    this.markers = null;\n\n    /**\n     * @member {HTMLElement}\n     * @readonly\n     * @private\n     */\n    this.container = document.createElement('div');\n    utils.addClasses(this.container, `psv-compass psv-compass--${this.config.position.join('-')}`);\n    this.container.innerHTML = this.config.backgroundSvg;\n\n    this.container.style.width = this.config.size;\n    this.container.style.height = this.config.size;\n    if (this.config.position[0] === 'center') {\n      this.container.style.marginTop = `calc(-${this.config.size} / 2)`;\n    }\n    if (this.config.position[1] === 'center') {\n      this.container.style.marginLeft = `calc(-${this.config.size} / 2)`;\n    }\n\n    /**\n     * @member {HTMLCanvasElement}\n     * @readonly\n     * @private\n     */\n    this.canvas = document.createElement('canvas');\n\n    this.container.appendChild(this.canvas);\n\n    if (this.config.navigation) {\n      this.container.addEventListener('mouseenter', this);\n      this.container.addEventListener('mouseleave', this);\n      this.container.addEventListener('mousemove', this);\n      this.container.addEventListener('mousedown', this);\n      this.container.addEventListener('mouseup', this);\n      this.container.addEventListener('touchstart', this);\n      this.container.addEventListener('touchmove', this);\n      this.container.addEventListener('touchend', this);\n    }\n  }\n\n  /**\n   * @package\n   */\n  init() {\n    super.init();\n\n    this.markers = this.psv.getPlugin('markers');\n\n    this.psv.container.appendChild(this.container);\n\n    this.canvas.width = this.container.clientWidth * SYSTEM.pixelRatio;\n    this.canvas.height = this.container.clientWidth * SYSTEM.pixelRatio;\n\n    this.psv.on(CONSTANTS.EVENTS.RENDER, this);\n\n    if (this.markers) {\n      this.markers.on('set-markers', this);\n    }\n  }\n\n  /**\n   * @package\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.RENDER, this);\n\n    if (this.markers) {\n      this.markers.off('set-markers', this);\n    }\n\n    this.psv.container.removeChild(this.container);\n\n    delete this.canvas;\n    delete this.container;\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    switch (e.type) {\n      case CONSTANTS.EVENTS.RENDER:\n        this.__update();\n        break;\n      case 'set-markers':\n        this.prop.markers = e.args[0].filter(m => m.data?.compass);\n        this.__update();\n        break;\n      case 'mouseenter':\n      case 'mousemove':\n      case 'touchmove':\n        this.prop.mouse = e.changedTouches?.[0] || e;\n        if (this.prop.mouseDown) {\n          this.__click();\n        }\n        else {\n          this.__update();\n        }\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mousedown':\n      case 'touchstart':\n        this.prop.mouseDown = true;\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mouseup':\n      case 'touchend':\n        this.prop.mouse = e.changedTouches?.[0] || e;\n        this.prop.mouseDown = false;\n        this.__click();\n        if (e.changedTouches) {\n          this.prop.mouse = null;\n          this.__update();\n        }\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mouseleave':\n        this.prop.mouse = null;\n        this.prop.mouseDown = false;\n        this.__update();\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * @summary Changes the hotspots on the compass\n   * @param {PSV.plugins.CompassPlugin.Hotspot[]} hotspots\n   */\n  setHotspots(hotspots) {\n    this.config.hotspots = hotspots;\n    this.__update();\n  }\n\n  /**\n   * @summary Removes all hotspots\n   */\n  clearHotspots() {\n    this.setHotspots(null);\n  }\n\n  /**\n   * @summary Updates the compass for current zoom and position\n   * @private\n   */\n  __update() {\n    const context = this.canvas.getContext('2d');\n    context.clearRect(0, 0, this.canvas.width, this.canvas.height);\n\n    const longitude = this.psv.getPosition().longitude;\n    const fov = THREE.Math.degToRad(this.psv.prop.hFov);\n\n    this.__drawCone(context, this.config.coneColor, longitude, fov);\n\n    const mouseAngle = this.__getMouseAngle();\n    if (mouseAngle !== null) {\n      this.__drawCone(context, this.config.navigationColor, mouseAngle, fov);\n    }\n\n    this.prop.markers.forEach((marker) => {\n      this.__drawMarker(context, marker);\n    });\n    this.config.hotspots?.forEach((spot) => {\n      if ('longitude' in spot && !('latitude' in spot)) {\n        spot.latitude = 0;\n      }\n      const pos = this.psv.dataHelper.cleanPosition(spot);\n      this.__drawPoint(context, spot.color || this.config.hotspotColor, pos.longitude, pos.latitude);\n    });\n  }\n\n  /**\n   * @summary Rotates the viewer depending on the position of the mouse on the compass\n   * @private\n   */\n  __click() {\n    const mouseAngle = this.__getMouseAngle();\n\n    if (mouseAngle !== null) {\n      this.psv.rotate({\n        longitude: mouseAngle,\n        latitude : 0,\n      });\n    }\n  }\n\n  /**\n   * @summary Draw a cone\n   * @param {CanvasRenderingContext2D} context\n   * @param {string} color\n   * @param {number} longitude - in viewer reference\n   * @param {number} fov\n   * @private\n   */\n  __drawCone(context, color, longitude, fov) {\n    const a1 = longitude - Math.PI / 2 - fov / 2;\n    const a2 = a1 + fov;\n    const c = this.canvas.width / 2;\n\n    context.beginPath();\n    context.moveTo(c, c);\n    context.lineTo(c + Math.cos(a1) * c, c + Math.sin(a1) * c);\n    context.arc(c, c, c, a1, a2, false);\n    context.lineTo(c, c);\n    context.fillStyle = color;\n    context.fill();\n  }\n\n  /**\n   * @summary Draw a Marker\n   * @param {CanvasRenderingContext2D} context\n   * @param {PSV.plugins.MarkersPlugin.Marker} marker\n   * @private\n   */\n  __drawMarker(context, marker) {\n    let color = this.config.hotspotColor;\n    if (typeof marker.data.compass === 'string') {\n      color = marker.data.compass;\n    }\n\n    if (marker.isPoly()) {\n      context.beginPath();\n      marker.props.def.forEach(([longitude, latitude], i) => {\n        const a = longitude - Math.PI / 2;\n        const d = (latitude + Math.PI / 2) / Math.PI;\n        const c = this.canvas.width / 2;\n\n        context[i === 0 ? 'moveTo' : 'lineTo'](c + Math.cos(a) * c * d, c + Math.sin(a) * c * d);\n      });\n      if (marker.isPolygon()) {\n        context.fillStyle = color;\n        context.fill();\n      }\n      else {\n        context.strokeStyle = color;\n        context.lineWidth = Math.max(1, this.canvas.width * HOTSPOT_SIZE_RATIO / 2);\n        context.stroke();\n      }\n    }\n    else {\n      const pos = marker.props.position;\n      this.__drawPoint(context, color, pos.longitude, pos.latitude);\n    }\n  }\n\n  /**\n   * @summary Draw a point\n   * @param {CanvasRenderingContext2D} context\n   * @param {string} color\n   * @param {number} longitude - in viewer reference\n   * @param {number} latitude - in viewer reference\n   * @private\n   */\n  __drawPoint(context, color, longitude, latitude) {\n    const a = longitude - Math.PI / 2;\n    const d = (latitude + Math.PI / 2) / Math.PI;\n    const c = this.canvas.width / 2;\n    const r = Math.max(2, this.canvas.width * HOTSPOT_SIZE_RATIO);\n\n    context.beginPath();\n    context.ellipse(\n      c + Math.cos(a) * c * d, c + Math.sin(a) * c * d,\n      r, r,\n      0, 0, Math.PI * 2\n    );\n    context.fillStyle = color;\n    context.fill();\n  }\n\n  /**\n   * @summary Gets the longitude corresponding to the mouse position on the compass\n   * @return {number | null}\n   * @private\n   */\n  __getMouseAngle() {\n    if (!this.prop.mouse) {\n      return null;\n    }\n\n    const boundingRect = this.container.getBoundingClientRect();\n    const mouseX = this.prop.mouse.clientX - boundingRect.left - boundingRect.width / 2;\n    const mouseY = this.prop.mouse.clientY - boundingRect.top - boundingRect.width / 2;\n\n    if (Math.sqrt(mouseX * mouseX + mouseY * mouseY) > boundingRect.width / 2) {\n      return null;\n    }\n\n    return Math.atan2(mouseY, mouseX) + Math.PI / 2;\n  }\n\n}\n"],"names":["HOTSPOT_SIZE_RATIO","CompassPlugin","psv","options","config","size","position","backgroundSvg","compass","coneColor","navigation","navigationColor","hotspotColor","utils","cleanPosition","prop","mouse","mouseDown","markers","container","document","createElement","addClasses","join","innerHTML","style","width","height","marginTop","marginLeft","canvas","appendChild","addEventListener","init","getPlugin","clientWidth","SYSTEM","pixelRatio","on","CONSTANTS","EVENTS","RENDER","destroy","off","removeChild","handleEvent","e","type","__update","args","filter","m","data","changedTouches","__click","stopPropagation","preventDefault","setHotspots","hotspots","clearHotspots","context","getContext","clearRect","longitude","getPosition","fov","THREE","Math","degToRad","hFov","__drawCone","mouseAngle","__getMouseAngle","forEach","marker","__drawMarker","spot","latitude","pos","dataHelper","__drawPoint","color","rotate","a1","PI","a2","c","beginPath","moveTo","lineTo","cos","sin","arc","fillStyle","fill","isPoly","props","def","i","a","d","isPolygon","strokeStyle","lineWidth","max","stroke","r","ellipse","boundingRect","getBoundingClientRect","mouseX","clientX","left","mouseY","clientY","top","sqrt","atan2","AbstractPlugin","id"],"mappings":"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"}